<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cervical Cancer Risk Assessment</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .container { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
    .nav { margin-bottom: 20px; text-align: center; }
    .nav a, .nav button { margin: 0 10px; padding: 8px 15px; text-decoration: none; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .nav a:hover, .nav button:hover { background: #0056b3; }
    .form-group { margin-bottom: 15px; }
    .section { display: none; margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    .section:first-of-type { display: block; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
    input[type="radio"] { width: auto; margin-right: 5px; }
    .next-btn, .submit-btn { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
    .progress-container { margin: 20px 0; background: #f0f0f0; border-radius: 10px; height: 20px; position: relative; }
    .progress-bar { height: 100%; background: #4CAF50; border-radius: 10px; width: 0%; transition: width 0.3s; }
    .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; }
    .loading { text-align: center; padding: 20px; background: #f9f9f9; border-radius: 5px; }
    #result { margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 5px; display: none; }
    .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 5px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cervical Cancer Risk Assessment Tool</h1>
    <p style="text-align:center;">Designed to promote preventive healthcare for women</p>

    <!-- Navigation -->
    <div class="nav">
      <a href="{{ url_for('home') }}">Home</a>
      <a href="{{ url_for('profile_page') }}">Profile</a>
      <a href="{{ url_for('history') }}">Symptom History</a>
      <button id="logout-btn">Logout</button>
    </div>

    <!-- Add CSRF token meta tag -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Progress bar -->
    <div class="progress-container">
      <div id="progress-bar" class="progress-bar"></div>
      <div id="progress-text" class="progress-text">0% Complete</div>
    </div>

    <!-- Result section -->
    <div id="result"></div>

    <!-- Loading indicator -->
    <div id="loading" class="loading" style="display: none;">
      <p>Processing your assessment...</p>
    </div>

    <form id="assessment-form">
      <!-- Hidden CSRF token field -->
      <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token }}">
      
      <!-- SECTION 1: Demographic Info -->
      <fieldset class="section" id="demographic-info">
        <legend>Demographic Information</legend>
        <div class="form-group">
          <label for="full_name">Full Name (including middle initial):</label>
          <input type="text" id="full_name" name="full_name" required>
        </div>
        <div class="form-group">
          <label for="dob">Date of Birth:</label>
          <input type="date" id="dob" name="dob" required>
        </div>
        <div class="form-group">
          <label for="address">Address:</label>
          <input type="text" id="address" name="address" required>
        </div>
        <div class="form-group">
          <label for="ethnicity">Ethnicity:</label>
          <select id="ethnicity" name="ethnicity" onchange="toggleEthnicityOther()" required>
            <option value="">Select</option>
            <option value="Hausa">Hausa</option>
            <option value="Yoruba">Yoruba</option>
            <option value="Igbo">Igbo</option>
            <option value="Fulani">Fulani</option>
            <option value="Kanuri">Kanuri</option>
            <option value="Other">Other</option>
          </select>
          <div id="ethnicity_other" style="margin-top: 10px; display: none;">
            <label for="ethnicity_other_input">Please specify:</label>
            <input type="text" id="ethnicity_other_input" name="ethnicity_other_input">
          </div>
        </div>
        <button type="button" class="next-btn" onclick="showNextSection('demographic-info', 'primary-symptoms')">Next</button>
      </fieldset>

      <!-- SECTION 2: Primary Symptoms -->
      <fieldset class="section" id="primary-symptoms">
        <legend>Primary Symptoms</legend>
        <div class="form-group">
          <label>Do you have abnormal vaginal bleeding?</label><br>
          <input type="radio" id="abnormal_bleeding_yes" name="abnormal_vaginal_bleeding" value="yes" onchange="toggleBleedingType()" required> Yes<br>
          <input type="radio" id="abnormal_bleeding_no" name="abnormal_vaginal_bleeding" value="no" onchange="toggleBleedingType()" required> No<br>
          <div id="bleeding_type" style="margin-top: 10px; display: none;">
            <label for="bleeding_type_select">What type of abnormal bleeding?</label><br>
            <select id="bleeding_type_select" name="bleeding_type">
              <option value="">Select</option>
              <option value="intermenstrual">Intermenstrual</option>
              <option value="post-coital">Post-coital</option>
              <option value="heavier periods">Heavier periods</option>
              <option value="postmenopausal">Postmenopausal</option>
            </select>
            <input type="hidden" id="is_post_coital_or_post_menopausal" name="is_post_coital_or_post_menopausal" value="no">
          </div>
        </div>
        <div class="form-group">
          <label>Do you have abnormal vaginal discharge?</label><br>
          <input type="radio" id="abnormal_discharge_yes" name="abnormal_vaginal_discharge" value="yes" required> Yes<br>
          <input type="radio" id="abnormal_discharge_no" name="abnormal_vaginal_discharge" value="no" required> No
        </div>
        <div class="form-group">
          <label>Do you have lower abdominal pain?</label><br>
          <input type="radio" id="lower_abdominal_pain_yes" name="lower_abdominal_pain" value="yes" required> Yes<br>
          <input type="radio" id="lower_abdominal_pain_no" name="lower_abdominal_pain" value="no" required> No
        </div>
        <button type="button" class="next-btn" onclick="showNextSection('primary-symptoms', 'additional-symptoms')">Next</button>
      </fieldset>

      <!-- SECTION 3: Additional Symptoms -->
      <fieldset class="section" id="additional-symptoms">
        <legend>Additional Symptoms</legend>
        <div class="form-group">
          <label>Is sexual intercourse painful for you?</label><br>
          <input type="radio" id="painful_intercourse_yes" name="dyspareunia" value="yes" required> Yes<br>
          <input type="radio" id="painful_intercourse_no" name="dyspareunia" value="no" required> No
        </div>
        <div class="form-group">
          <label>Are you experiencing a change in your menstrual periods?</label><br>
          <input type="radio" id="changed_periods_yes" name="change_in_periods" value="yes" required> Yes<br>
          <input type="radio" id="changed_periods_no" name="change_in_periods" value="no" required> No
        </div>
        <div class="form-group">
          <label>Are you having unexplained weight loss?</label><br>
          <input type="radio" id="weight_loss_yes" name="weight_loss" value="yes" required> Yes<br>
          <input type="radio" id="weight_loss_no" name="weight_loss" value="no" required> No
        </div>
        <div class="form-group">
          <label>Are you experiencing unusual fatigue?</label><br>
          <input type="radio" id="unusual_fatigue_yes" name="unusual_fatigue" value="yes" required> Yes<br>
          <input type="radio" id="unusual_fatigue_no" name="unusual_fatigue" value="no" required> No
        </div>
        <button type="button" class="next-btn" onclick="showNextSection('additional-symptoms', 'risk-factors')">Next</button>
      </fieldset>

      <!-- SECTION 4: Risk Factors -->
      <fieldset class="section" id="risk-factors">
        <legend>Risk Factors</legend>
        <div class="form-group">
          <label>Are you currently pregnant?</label><br>
          <input type="radio" id="is_pregnant_yes" name="is_pregnant" value="yes" required> Yes<br>
          <input type="radio" id="is_pregnant_no" name="is_pregnant" value="no" required> No
        </div>
        <div class="form-group">
          <label>Number of sexual partners in lifetime?</label>
          <select name="sexual_partners" required>
            <option value="">Select</option>
            <option value="0">0</option>
            <option value="1–3">1–3</option>
            <option value="4–7">4–7</option>
            <option value=">8">>8</option>
          </select>
        </div>
        <div class="form-group">
          <label>How old were you when you first had intercourse?</label>
          <select name="age_first_intercourse" required>
            <option value="">Select</option>
            <option value="<16 years"><16 years</option>
            <option value="17–20 years">17–20 years</option>
            <option value=">21 years">>21 years</option>
            <option value="Not applicable">Not applicable</option>
          </select>
        </div>
        <div class="form-group">
          <label>Do you use or have you used hormonal contraceptives?</label><br>
          <input type="radio" id="contraceptive_use_yes" name="oral_contraceptive_use" value="yes" onchange="toggleContraceptiveYears()" required> Yes<br>
          <input type="radio" id="contraceptive_use_no" name="oral_contraceptive_use" value="no" onchange="toggleContraceptiveYears()" required> No
          <div id="contraceptive_use_years" style="margin-top: 10px; display: none;">
            <label>For how long?</label>
            <select name="contraceptive_years">
              <option value="<5 years"><5 years</option>
              <option value="5–9 years">5–9 years</option>
              <option value=">10 years">>10 years</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Do you smoke?</label>
          <select name="smoking" onchange="toggleCigarettesPerDay()" required>
            <option value="">Select</option>
            <option value="Never">Never</option>
            <option value="Current">Current</option>
            <option value="Previous">Previous</option>
          </select>
          <div id="cigarettes_per_day" style="margin-top: 10px; display: none;">
            <label>Cigarettes per day:</label>
            <select name="cigarettes_per_day">
              <option value="">Select</option>
              <option value="1–9/day">1–9/day</option>
              <option value="10–19/day">10–19/day</option>
              <option value=">20/day">>20/day</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Have you had a pap smear, HPV test or VIA test in the past?</label><br>
          <input type="radio" id="had_pap_smear_yes" name="had_pap_smear" value="yes" onchange="togglePapResult()" required> Yes<br>
          <input type="radio" id="had_pap_smear_no" name="had_pap_smear" value="no" onchange="togglePapResult()" required> No
          <div id="pap_result" style="margin-top: 10px; display: none;">
            <label>Was the result normal or abnormal?</label><br>
            <input type="radio" id="pap_result_normal" name="abnormal_pap_smear" value="no"> Normal<br>
            <input type="radio" id="pap_result_abnormal" name="abnormal_pap_smear" value="yes"> Abnormal
          </div>
        </div>
        <div class="form-group">
          <label>What is your HIV status?</label>
          <select name="hiv_status" onchange="updateHIVPositive()" required>
            <option value="">Select</option>
            <option value="Negative">Negative</option>
            <option value="Positive">Positive</option>
            <option value="Unknown">Unknown</option>
          </select>
          <input type="hidden" id="hiv_positive" name="hiv_positive" value="no">
        </div>
        <div class="form-group">
          <label>How many children have you given birth to?</label>
          <select name="parity" onchange="updateHighParity()" required>
            <option value="">Select</option>
            <option value="<5 children"><5 children</option>
            <option value=">=5 children">≥5 children</option>
          </select>
          <input type="hidden" id="high_parity" name="high_parity" value="no">
        </div>
        <div class="form-group">
          <label>What is your marital status?</label>
          <select name="marital_status" required>
            <option value="">Select</option>
            <option value="Single">Single</option>
            <option value="Married">Married</option>
            <option value="Divorced">Divorced</option>
          </select>
        </div>
        <button type="submit" class="submit-btn">Calculate Risk</button>
      </fieldset>
    </form>
  </div>

  <script>
    // Get CSRF token from meta tag or create one
    async function getCSRFToken() {
      let token = document.querySelector('meta[name="csrf-token"]');
      if (token && token.getAttribute('content')) {
        return Promise.resolve(token.getAttribute('content'));
      }

      token = document.querySelector('input[name="csrf_token"]');
      if (token && token.value) {
        return Promise.resolve(token.value);
      }

      return fetch('/home', {
        method: 'GET',
        credentials: 'include'
      })
      .then(response => response.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const csrfInput = doc.querySelector('input[name="csrf_token"]');
        if (csrfInput) {
          return csrfInput.value;
        }
        const csrfMeta = doc.querySelector('meta[name="csrf-token"]');
        if (csrfMeta) {
          return csrfMeta.getAttribute('content');
        }
        return null;
      })
      .catch(() => null);
    }

    function showNextSection(currentId, nextId) {
      document.getElementById(currentId).style.display = "none";
      document.getElementById(nextId).style.display = "block";
      updateProgress();
    }

    function toggleBleedingType() {
      const bleedingYes = document.getElementById("abnormal_bleeding_yes").checked;
      document.getElementById("bleeding_type").style.display = bleedingYes ? "block" : "none";
      document.getElementById("is_post_coital_or_post_menopausal").value = "no";
    }

    document.getElementById("bleeding_type_select").addEventListener("change", function () {
      const bleedingType = this.value.toLowerCase();
      const isPostCoitalOrMenopausal =
        bleedingType.includes("post-coital") ||
        bleedingType.includes("postcoital") ||
        bleedingType.includes("post-menopausal") ||
        bleedingType.includes("postmenopausal");
      document.getElementById("is_post_coital_or_post_menopausal").value =
        isPostCoitalOrMenopausal ? "yes" : "no";
    });

    function toggleEthnicityOther() {
      const ethnicity = document.getElementById("ethnicity").value;
      document.getElementById("ethnicity_other").style.display = ethnicity === "Other" ? "block" : "none";
    }

    function toggleContraceptiveYears() {
      const contraceptiveYes = document.getElementById("contraceptive_use_yes").checked;
      document.getElementById("contraceptive_use_years").style.display = contraceptiveYes ? "block" : "none";
    }

    function toggleCigarettesPerDay() {
      const smokingStatus = document.querySelector('select[name="smoking"]').value;
      document.getElementById("cigarettes_per_day").style.display =
        smokingStatus === "Current" || smokingStatus === "Previous" ? "block" : "none";
    }

    function togglePapResult() {
      const papYes = document.getElementById("had_pap_smear_yes").checked;
      document.getElementById("pap_result").style.display = papYes ? "block" : "none";
      if (!papYes) {
        const papRadios = document.querySelectorAll('input[name="abnormal_pap_smear"]');
        papRadios.forEach(radio => radio.checked = false);
      }
    }

    function updateHIVPositive() {
      const hivStatus = document.querySelector('select[name="hiv_status"]').value;
      document.getElementById("hiv_positive").value = hivStatus === "Positive" ? "yes" : "no";
    }

    function updateHighParity() {
      const parity = document.querySelector('select[name="parity"]').value;
      document.getElementById("high_parity").value = parity === ">=5 children" ? "yes" : "no";
    }

    function updateProgress() {
      const sections = document.querySelectorAll(".section");
      let completed = 0;
      sections.forEach(section => {
        if (section.style.display === "none") completed++;
      });
      const progress = (completed / sections.length) * 100;
      document.getElementById("progress-bar").style.width = progress + "%";
      document.getElementById("progress-text").innerText = Math.round(progress) + "% Complete";
    }

    // Convert FormData to JSON object
    function formDataToJSON(formData) {
      const json = {};
      for (let [key, value] of formData.entries()) {
        json[key] = value;
      }
      return json;
    }

    // Handle form submission
    document.getElementById('assessment-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Show loading indicator
      document.getElementById('loading').style.display = 'block';
      document.getElementById('result').style.display = 'none';

      const formData = new FormData(this);
      const jsonData = formDataToJSON(formData);

      // Get CSRF token
      let csrfToken = await getCSRFToken();
      if (csrfToken) {
        jsonData.csrf_token = csrfToken;
      }

      console.log('Submitting data:', jsonData);

      fetch('/api/symptom-checker', {
        method: 'POST',
        body: JSON.stringify(jsonData),
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          ...(csrfToken && { 'X-CSRFToken': csrfToken })
        },
        credentials: 'include'
      })
      .then(response => {
        console.log('Symptom checker response status:', response.status);
        document.getElementById('loading').style.display = 'none';
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.message || `HTTP ${response.status}: ${response.statusText}`);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('Symptom checker response data:', data);
        if (data.success) {
          if (data.message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success';
            messageDiv.textContent = data.message;
            document.querySelector('.container').insertBefore(messageDiv, document.getElementById('result'));
            setTimeout(() => messageDiv.remove(), 5000);
          }

          if (data.data) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
              <h2>Risk Score: ${data.data.risk_score}%</h2>
              <h3>Risk Category: ${data.data.risk_category}</h3>
              <h4>Scenario: ${data.data.scenario}</h4>
              <h4>Predefined Recommendations:</h4>
              <p>${data.data.predefined_recommendations.replace(/\n/g, '<br>')}</p>
              <h4>Personalized Recommendations:</h4>
              <ul>${data.data.personalized_recommendations.map(rec => `<li>${rec}</li>`).join('')}</ul>
            `;
            resultDiv.style.display = 'block';
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('progress-text').innerText = 'Assessment Complete';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
          }
        } else {
          throw new Error(data.message || 'Assessment failed');
        }
      })
      .catch(error => {
        console.error('Symptom checker error:', error);
        document.getElementById('loading').style.display = 'none';

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = error.message;
        document.querySelector('.container').insertBefore(errorDiv, document.getElementById('result'));
        setTimeout(() => errorDiv.remove(), 10000);

        if (error.message.includes('Please log in') || error.message.includes('401')) {
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        }
      });
    });

    // Handle logout
    document.getElementById('logout-btn').addEventListener('click', function () {
      fetch('/api/logout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'include'
      })
      .then(response => response.json())
      .then(data => {
        console.log('Logout response:', data);
        if (data.success) {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'success';
          messageDiv.textContent = data.message || 'Logged out successfully';
          document.querySelector('.container').appendChild(messageDiv);
          setTimeout(() => {
            window.location.href = '/login';
          }, 1000);
        } else {
          throw new Error(data.message || 'Logout failed');
        }
      })
      .catch(error => {
        console.error('Logout error:', error);
        window.location.href = '/login';
      });
    });

    // Initialize form fields on load
    document.addEventListener('DOMContentLoaded', async function () {
      try {
        const csrfToken = await getCSRFToken();
        if (csrfToken) {
          const csrfInput = document.getElementById('csrf_token');
          if (csrfInput) {
            csrfInput.value = csrfToken;
          }
          let metaTag = document.querySelector('meta[name="csrf-token"]');
          if (!metaTag) {
            metaTag = document.createElement('meta');
            metaTag.name = 'csrf-token';
            metaTag.content = csrfToken;
            document.head.appendChild(metaTag);
          } else if (!metaTag.getAttribute('content')) {
            metaTag.setAttribute('content', csrfToken);
          }
        }
      } catch (error) {
        console.warn('Could not get CSRF token:', error);
      }

      toggleBleedingType();
      toggleEthnicityOther();
      toggleContraceptiveYears();
      toggleCigarettesPerDay();
      togglePapResult();
      updateHIVPositive();
      updateHighParity();
      updateProgress();
    });
  </script>
</body>
</html>