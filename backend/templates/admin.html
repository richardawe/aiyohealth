<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Cervical Cancer Risk Assessment</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
    .container { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
    h1, h2 { color: #333; }
    .nav a, .nav button { margin-right: 10px; padding: 8px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; text-decoration: none; cursor: pointer; }
    .nav button#logout-btn { background-color: #d33; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .btn { background-color: #4CAF50; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .btn.delete { background-color: #d33; }
    .error { color: red; }
    .success { color: green; }
    .analytics { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Dashboard</h1>

    <div class="nav">
      <a href="{{ url_for('home') }}">Home</a>
      <a href="{{ url_for('profile') }}">Profile</a>
      <button id="logout-btn">Logout</button>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <p class="{{ category }}">{{ message }}</p>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="analytics">
      <h2>Analytics</h2>
      <div id="analytics-data"></div>
    </div>

    <h2>Users</h2>
    <div id="users-table"></div>
    <div id="pagination" style="margin-top: 20px;"></div>
  </div>

  <script>
    function fetchAnalytics() {
      fetch('{{ url_for("admin_analytics") }}', {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'include'
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to fetch analytics');
        return response.json();
      })
      .then(data => {
        if (data.success) {
          document.getElementById('analytics-data').innerHTML = `
            <p>Total Users: ${data.total_users}</p>
            <p>Total Assessments: ${data.total_assessments}</p>
            <p>Recent Assessments (30 days): ${data.recent_assessments}</p>
            <h3>Risk Distribution</h3>
            <ul>${data.risk_distribution.map(r => `<li>${r.category}: ${r.count}</li>`).join('')}</ul>
            <h3>Role Distribution</h3>
            <ul>${data.role_distribution.map(r => `<li>${r.role}: ${r.count}</li>`).join('')}</ul>
          `;
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        alert(error.message);
        if (error.message.includes('log in')) window.location.href = '{{ url_for("login") }}';
      });
    }

    function fetchUsers(page = 1) {
      fetch(`{{ url_for("admin_get_users") }}?page=${page}&per_page=20`, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'include'
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to fetch users');
        return response.json();
      })
      .then(data => {
        const tableDiv = document.getElementById('users-table');
        if (data.success && data.users.length > 0) {
          tableDiv.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${data.users.map(user => `
                  <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>
                      <select onchange="updateUserRole(${user.id}, this.value)">
                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        <option value="provider" ${user.role === 'provider' ? 'selected' : ''}>Provider</option>
                      </select>
                    </td>
                    <td>
                      <button class="btn delete" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          const paginationDiv = document.getElementById('pagination');
          let paginationHTML = '';
          if (data.current_page > 1) {
            paginationHTML += `<a href="#" onclick="fetchUsers(${data.current_page - 1})">Previous</a>`;
          }
          for (let i = 1; i <= data.pages; i++) {
            paginationHTML += `<a href="#" class="${i === data.current_page ? 'active' : ''}" onclick="fetchUsers(${i})">${i}</a>`;
          }
          if (data.current_page < data.pages) {
            paginationHTML += `<a href="#" onclick="fetchUsers(${data.current_page + 1})">Next</a>`;
          }
          paginationDiv.innerHTML = paginationHTML;
        } else {
          tableDiv.innerHTML = '<p>No users found.</p>';
          paginationDiv.innerHTML = '';
        }
      })
      .catch(error => {
        alert(error.message);
        if (error.message.includes('log in')) window.location.href = '{{ url_for("login") }}';
      });
    }

    function updateUserRole(userId, role) {
      fetch(`{{ url_for("admin_manage_user", user_id=0) }}`.replace('0', userId), {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ role }),
        credentials: 'include'
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to update user');
        return response.json();
      })
      .then(data => {
        if (data.success) {
          alert(data.message);
        } else {
          alert(data.message);
        }
      })
      .catch(error => alert(error.message));
    }

    function deleteUser(userId) {
      if (confirm('Are you sure you want to delete this user?')) {
        fetch(`{{ url_for("admin_manage_user", user_id=0) }}`.replace('0', userId), {
          method: 'DELETE',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          credentials: 'include'
        })
        .then(response => {
          if (!response.ok) throw new Error('Failed to delete user');
          return response.json();
        })
        .then(data => {
          if (data.success) {
            alert(data.message);
            fetchUsers();
          } else {
            alert(data.message);
          }
        })
        .catch(error => alert(error.message));
      }
    }

    document.getElementById('logout-btn').addEventListener('click', () => {
      fetch('{{ url_for("logout") }}', {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'include'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message || 'Logged out successfully');
          window.location.href = '{{ url_for("login") }}';
        } else {
          alert(data.message || 'Logout failed');
        }
      })
      .catch(error => {
        console.error('Logout error:', error);
        window.location.href = '{{ url_for("login") }}';
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      fetchAnalytics();
      fetchUsers();
    });
  </script>
</body>
</html>